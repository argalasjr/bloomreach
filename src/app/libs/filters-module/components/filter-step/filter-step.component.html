<div class="filter-step">
  <div class="filter-step__header">
    <div class="filter-step__header-left">
      <span class="filter-step__number">Step {{ stepNumber() }}</span>
      @if (selectedEventType()) {
        <span class="filter-step__event-name">{{ selectedEventType()?.label || '' }}</span>
      }
    </div>
    @if (isComplete()) {
      <div class="filter-step__header-actions">
        <button
          class="filter-step__action filter-step__action--duplicate"
          (click)="onDuplicate()"
          type="button"
          title="Duplicate step"
        >
          <span class="filter-step__action-icon">âŽ˜</span>
        </button>
        @if (canRemove()) {
          <button
            class="filter-step__action filter-step__action--delete"
            (click)="onRemove()"
            type="button"
            title="Delete step"
          >
            <span class="filter-step__action-icon">ðŸ—‘</span>
          </button>
        }
      </div>
    }
  </div>

  <div
    class="filter-step__content"
    [class.filter-step__content--has-attributes]="selectedEventType()"
  >
    @for (
      attribute of attributeFilters();
      track attribute.id;
      let first = $first;
      let last = $last
    ) {
      <div class="filter-step__row" [class.filter-step__row--last]="last">
        <!-- Event Type (only show in first row) -->
        <div
          class="filter-step__field filter-step__field--event"
          [class.filter-step__field--hidden]="!first"
        >
          @if (first) {
            <label class="filter-step__label">Event</label>
            <app-select
              [items]="eventTypeOptions()"
              [value]="selectedEventType()"
              placeholder="Event type..."
              (valueChange)="onEventTypeChange($event)"
            >
            </app-select>
          }
        </div>

        <!-- Property -->
        <div
          class="filter-step__field filter-step__field--property"
          [class.filter-step__field--hidden]="!selectedEventType()"
        >
          <label class="filter-step__label">Attribute</label>
          <app-select
            [items]="propertyOptions()"
            [value]="attribute.property"
            (valueChange)="updateAttributeProperty(attribute.id, $event)"
            placeholder="Property..."
          >
          </app-select>
          @if (last && attribute.property) {
            <button class="filter-step__add-attribute" (click)="addAttributeFilter()" type="button">
              + Add Row
            </button>
          }
        </div>

        <!-- Operator -->
        @if (attribute.property) {
          <div class="filter-step__field">
            <label class="filter-step__label">Operator</label>
            <app-select
              [tabs]="attribute.property ? operatorTabs : []"
              [value]="attribute.operator"
              (valueChange)="updateAttributeOperator(attribute.id, $event)"
              placeholder="Operator..."
            >
            </app-select>
          </div>
        }

        <!-- Value (for non-between operators) -->
        @if (attribute.operator && attribute.operator.value !== 'between') {
          <div class="filter-step__field filter-step__field--value">
            <label class="filter-step__label">Value</label>
            <input
              [type]="propertyTypeMap().get(attribute.id) || 'text'"
              class="g-input"
              [value]="attribute.value || ''"
              (input)="onValueChange(attribute.id, $event)"
              placeholder="Value..."
            />
          </div>
        }
        <!-- Value Range (for between operator) -->
        @if (attribute.operator?.value === 'between') {
          <div class="row-between">
            <div class="filter-step__field filter-step__field--value-range">
              <label class="filter-step__label">From</label>
              <input
                type="number"
                class="g-input"
                [value]="attribute.valueFrom || ''"
                (input)="onValueFromChange(attribute.id, $event)"
                placeholder="From..."
              />
            </div>

            <div class="pl-2 pt-1">and</div>

            <div class="filter-step__field filter-step__field--value-range">
              <label class="filter-step__label">To</label>
              <input
                type="number"
                class="g-input"
                [value]="attribute.valueTo || ''"
                (input)="onValueToChange(attribute.id, $event)"
                placeholder="To..."
              />
            </div>
          </div>
        }

        <!-- Remove Button -->
        <div class="filter-step__field filter-step__field--action">
          @if (selectedEventType()) {
            <button
              class="filter-step__remove-row"
              (click)="removeAttributeFilter(attribute.id)"
              type="button"
              title="Remove row"
            >
              Ã—
            </button>
          }
        </div>
      </div>
    }
  </div>
</div>
