<div class="filter-step">
  <div class="filter-step__header">
    <div class="filter-step__header-left">
      <span class="filter-step__number">{{ stepNumber() }}. Step:</span>
      <app-editable-input
        [value]="name()"
        (valueChange)="onNameChange($event)"
        placeholder="Filter name..."
      />
    </div>
    @if (isComplete()) {
      <div class="filter-step__header-actions">
        <button
          class="filter-step__action filter-step__action--duplicate"
          (click)="onDuplicate()"
          type="button"
          title="Duplicate step"
        >
          <span class="filter-step__action-icon">üìã</span>
        </button>
        @if (canRemove()) {
          <button
            class="filter-step__action filter-step__action--delete"
            (click)="onRemove()"
            type="button"
            title="Delete step"
          >
            <span class="filter-step__action-icon">üóëÔ∏è</span>
          </button>
        }
      </div>
    }
  </div>

  <div
    class="filter-step__content"
    [class.filter-step__content--has-attributes]="selectedEventType()"
  >
    @for (
      attribute of attributeFilters();
      track attribute.id;
      let first = $first;
      let last = $last;
      let i = $index
    ) {
      <div class="filter-step__row" [class.filter-step__row--last]="last">
        <!-- Event Type (only show in first row) -->
        <div
          class="filter-step__field filter-step__field--event"
          [class.filter-step__field--hidden]="!first"
        >
          @if (first) {
            <label class="filter-step__label">Event</label>
            <app-select
              [field]="filterForm.eventType"
              [items]="eventTypeOptions()"
              placeholder="Event type..."
              [searchable]="true"
              [minTermLength]="1"
            >
            </app-select>
          }
        </div>

        <!-- Property -->
        <div
          class="filter-step__field filter-step__field--property"
          [class.filter-step__field--hidden]="!selectedEventType()"
        >
          <label class="filter-step__label">Attribute</label>
          <app-select
            [field]="filterForm.attributeFilters[i].property"
            [items]="propertyOptions()"
            [exclusiveOption]="selectedEventType()"
            placeholder="Property..."
            [searchable]="true"
          >
          </app-select>
          @if (last && attribute.property) {
            <button class="btn btn--text btn--sm" (click)="addAttributeFilter()" type="button">
              + Refine more
            </button>
          }
        </div>

        <!-- Operator -->
        @if (attribute.property) {
          <div class="filter-step__field filter-step__field--operator">
            <label class="filter-step__label">Operator</label>
            <app-select
              [field]="filterForm.attributeFilters[i].operator"
              [searchable]="false"
              [tabs]="attribute.property ? operatorTabs : []"
              placeholder="Operator..."
            >
            </app-select>
          </div>
        }

        <!-- Value (for non-between operators) -->
        @if (attribute.operator && attribute.operator.value !== 'between') {
          <div class="filter-step__field filter-step__field--value">
            <label class="filter-step__label">Value</label>
            <input
              [field]="filterForm.attributeFilters[i].value"
              [type]="propertyTypeMap().get(attribute.id) || 'text'"
              class="g-input"
              placeholder="Value..."
            />
          </div>
        }
        <!-- Value Range (for between operator) -->
        @if (attribute.operator?.value === 'between') {
          <div class="row-between">
            <div class="filter-step__field filter-step__field--value-range">
              <label class="filter-step__label">From</label>
              <input
                [field]="filterForm.attributeFilters[i].valueFrom"
                type="number"
                class="g-input"
                placeholder="From..."
              />
            </div>

            <div class="pt-1">and</div>

            <div class="filter-step__field filter-step__field--value-range">
              <label class="filter-step__label">To</label>
              <input
                [field]="filterForm.attributeFilters[i].valueTo"
                type="number"
                class="g-input"
                placeholder="To..."
              />
            </div>
          </div>
        }

        <!-- Remove Button -->
        <div class="filter-step__field filter-step__field--action">
          @if (selectedEventType()) {
            <button
              class="filter-step__remove-row"
              (click)="removeAttributeFilter(attribute.id)"
              type="button"
              title="Remove row"
            >
              √ó
            </button>
          }
        </div>
      </div>
    }
  </div>
</div>
